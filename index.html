<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Translator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      /* Prevent scrolling on the body, handle it in the container */
      overflow: hidden; 
    }
    
    /* Animations */
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.5; }
      100% { transform: scale(2); opacity: 0; }
    }
    .listening-ring { position: relative; }
    .listening-ring::before {
      content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 100%;
      background-color: #ef4444; border-radius: 50%; z-index: -1;
      animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }
    
    .caption-enter { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    @keyframes sound-wave { 0% { height: 4px; } 50% { height: 12px; } 100% { height: 4px; } }
    .playing-indicator .bar { width: 3px; background-color: #fff; border-radius: 9999px; animation: sound-wave 0.8s ease-in-out infinite; }
    .playing-indicator .bar:nth-child(1) { animation-delay: 0.0s; }
    .playing-indicator .bar:nth-child(2) { animation-delay: 0.1s; }
    .playing-indicator .bar:nth-child(3) { animation-delay: 0.2s; }

    /* Custom Toggles */
    .mode-btn.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
    .mode-btn { background-color: #1e293b; color: #94a3b8; border: 1px solid #334155; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
 </head>
 <body class="h-full bg-slate-900 text-slate-100 flex flex-col">

   <!-- 1. Header: Branding -->
   <header class="bg-slate-900 border-b border-slate-800 py-3 px-6 flex items-center justify-between shrink-0">
       <div class="flex items-center gap-3">
           <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg shadow-indigo-500/20">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
             </svg>
           </div>
           <div>
              <h1 class="text-lg font-bold text-white tracking-tight">Live Translator</h1>
              <p class="text-xs text-slate-400 font-medium">Classroom Edition</p>
           </div>
       </div>
       <div id="status-badge" class="hidden px-3 py-1 bg-red-500/10 text-red-400 border border-red-500/20 rounded-full text-xs font-semibold flex items-center gap-2">
           <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> Listening
       </div>
   </header>

   <!-- 2. Configuration Bar (The "Dashboard") -->
   <div class="bg-slate-800/50 border-b border-slate-700 p-4 shrink-0 transition-all duration-300">
       <div class="max-w-4xl mx-auto flex flex-col gap-4">
           
           <!-- Language Selection Group (Centered) -->
           <div class="flex flex-col md:flex-row items-center gap-4 w-full justify-center">
               
               <!-- Input Section -->
               <div class="w-full md:w-64">
                   <div class="relative">
                       <label class="absolute -top-2.5 left-3 bg-slate-900 px-2 flex items-center gap-1">
                           <!-- Microphone Icon -->
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                           </svg>
                           <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Input</span>
                       </label>
                       <select id="source-lang" class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none cursor-pointer">
                           <!-- Populated by JS -->
                       </select>
                   </div>
               </div>

               <!-- Direction Arrow (Simple Right Arrow for Input -> Output flow) -->
               <div class="flex-shrink-0 text-slate-500 bg-slate-800 p-2 rounded-full border border-slate-700">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
               </div>

               <!-- Output Section -->
               <div class="w-full md:w-64">
                   <div class="relative">
                       <label class="absolute -top-2.5 left-3 bg-slate-900 px-2 flex items-center gap-1">
                           <!-- Speaker/Audio Icon -->
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-emerald-400" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0117 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd" />
                           </svg>
                           <span class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider">Output</span>
                       </label>
                       <select id="target-lang" class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow outline-none cursor-pointer">
                           <!-- Populated by JS -->
                       </select>
                   </div>
               </div>
           </div>

           <!-- Mode Selection (Centered) -->
           <div class="flex justify-center">
               <div class="flex bg-slate-900 p-1 rounded-xl border border-slate-700 w-full max-w-sm">
                    <button id="mode-text" class="mode-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all whitespace-nowrap" onclick="setMode(false)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        Read
                    </button>
                    <button id="mode-audio" class="mode-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all whitespace-nowrap" onclick="setMode(true)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 18v-6a9 9 0 0118 0v6h-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4H3zM3 18h2v2H3v-2zm16 0h2v2h-2v-2z" /></svg>
                        Read & Listen
                    </button>
               </div>
           </div>

           <!-- Header Controls (Visible only when active/stopped) -->
           <div id="header-controls" class="hidden flex justify-center pt-1">
                <button id="header-start-btn" class="hidden w-full md:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2.5 px-8 rounded-xl shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Resume Listening
                </button>
                <button id="stop-btn" class="w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2.5 px-8 rounded-xl shadow-lg shadow-red-500/20 transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>
                    Stop Session
                </button>
           </div>

       </div>
   </div>

   <!-- 3. Main Content Area -->
   <main class="flex-1 overflow-hidden relative bg-slate-900">
     <div class="max-w-4xl mx-auto h-full flex flex-col p-4 md:p-6">
       
       <!-- Captions Container -->
       <div id="captions-container" class="flex-1 overflow-y-auto px-2 pb-24 space-y-6 scroll-smooth">
         
         <!-- Placeholder State (Start Button Here) -->
         <div id="placeholder-text" class="min-h-full py-8 flex flex-col items-center justify-center text-slate-500">
             <div class="bg-slate-800 p-8 md:p-12 rounded-3xl shadow-2xl border border-slate-700/50 mb-6 text-center max-w-lg w-full">
               
               <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-slate-700/50 mb-6 ring-1 ring-slate-600 flex-shrink-0">
                   <!-- Chat Icon -->
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                   </svg>
               </div>
               
               <h3 class="text-2xl font-bold text-white mb-8 tracking-tight">Ready to Connect</h3>

               <button id="hero-start-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3.5 px-8 rounded-2xl shadow-xl shadow-emerald-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3 text-lg group">
                    <span>Start Listening</span>
                    <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
               </button>
             </div>
         </div>

         <!-- Live Preview Draft Bubble (Hidden by default) -->
         <div id="live-preview" class="hidden mb-6 opacity-60">
            <div class="flex flex-col gap-2">
                <div class="flex items-start gap-3 max-w-[90%] self-start">
                    <div class="text-xs font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded animate-pulse">Listening...</div>
                    <p id="live-preview-text" class="text-slate-300 text-sm leading-relaxed italic"></p>
                    <span class="inline-block w-1.5 h-4 bg-emerald-500 cursor-blink mt-1"></span>
                </div>
            </div>
         </div>

       </div>
     </div>
   </main>

   <!-- 4. Floating Elements -->
   <div id="alerts-container" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 w-full max-w-md px-4 pointer-events-none flex flex-col gap-3 items-center z-50">
     
     <!-- Voice Active Toast -->
     <div id="voice-toast" class="bg-indigo-600 text-white px-5 py-3 rounded-2xl shadow-xl shadow-indigo-900/50 hidden pointer-events-auto flex items-center gap-4 transition-all duration-300 translate-y-4 opacity-0">
        <div class="playing-indicator flex gap-1 h-3 items-center">
            <div class="bar h-2"></div>
            <div class="bar h-3"></div>
            <div class="bar h-1"></div>
        </div>
        <div class="flex flex-col">
            <span class="text-[10px] uppercase tracking-wider font-bold opacity-80">Speaking Translation</span>
            <span id="voice-name" class="text-xs font-medium truncate max-w-[150px]">System Voice</span>
        </div>
     </div>

     <!-- Error Message -->
     <div id="error-message" class="bg-slate-800 border border-red-500/50 text-red-400 px-5 py-4 rounded-2xl shadow-xl hidden pointer-events-auto flex items-start gap-3 w-full">
        <span class="text-2xl mt-0.5">‚ö†Ô∏è</span>
        <div>
            <p class="font-bold text-sm text-white">System Alert</p>
            <span id="error-text" class="text-sm">An unexpected error occurred.</span>
        </div>
     </div>

     <!-- Permission Message -->
     <div id="permission-message" class="bg-slate-800 text-white px-6 py-5 rounded-3xl shadow-2xl border border-slate-600 hidden pointer-events-auto w-full">
      <div class="flex items-center gap-4">
       <div class="bg-slate-700 p-3 rounded-xl">
         <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
       </div>
       <div>
        <p class="font-bold text-lg mb-1">Microphone Access</p>
        <p class="text-sm text-slate-300">Please click "Allow" to enable speech recognition.</p>
       </div>
      </div>
     </div>
     
   </div>

  </div>

  <script>
    // --- Configuration & Data ---
    // Full locale codes for Speech Recognition & TTS
    const languages = [
        { code: 'en-US', name: 'üá∫üá∏ English (US)' },
        { code: 'es-ES', name: 'üá™üá∏ Spanish' },
        { code: 'pt-BR', name: 'üáßüá∑ Portuguese' },
        { code: 'fr-FR', name: 'üá´üá∑ French' },
        { code: 'de-DE', name: 'üá©üá™ German' },
        { code: 'it-IT', name: 'üáÆüáπ Italian' },
        { code: 'zh-CN', name: 'üá®üá≥ Chinese (Simplified)' },
        { code: 'ja-JP', name: 'üáØüáµ Japanese' },
        { code: 'ko-KR', name: 'üá∞üá∑ Korean' },
        { code: 'ru-RU', name: 'üá∑üá∫ Russian' },
        { code: 'ar-SA', name: 'üá∏üá¶ Arabic' },
        { code: 'hi-IN', name: 'üáÆüá≥ Hindi' },
        { code: 'nl-NL', name: 'üá≥üá± Dutch' },
        { code: 'tr-TR', name: 'üáπüá∑ Turkish' },
        { code: 'pl-PL', name: 'üáµüá± Polish' },
        { code: 'vi-VN', name: 'üáªüá≥ Vietnamese' },
        { code: 'uk-UA', name: 'üá∫üá¶ Ukrainian' }
    ];

    // --- State ---
    let recognition = null;
    let isListening = false;
    let isAudioMode = false; // Default to Text Only
    let transcriptCounter = 0;
    let availableVoices = [];

    // --- DOM Elements ---
    const sourceSelect = document.getElementById('source-lang');
    const targetSelect = document.getElementById('target-lang');
    const heroStartBtn = document.getElementById('hero-start-btn');
    const headerStartBtn = document.getElementById('header-start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const headerControls = document.getElementById('header-controls');
    const placeholderText = document.getElementById('placeholder-text');
    const statusBadge = document.getElementById('status-badge');
    const captionsContainer = document.getElementById('captions-container');
    const livePreview = document.getElementById('live-preview');
    const livePreviewText = document.getElementById('live-preview-text');
    
    const modeTextBtn = document.getElementById('mode-text');
    const modeAudioBtn = document.getElementById('mode-audio');
    const voiceToast = document.getElementById('voice-toast');
    const voiceNameSpan = document.getElementById('voice-name');
    const permissionMessage = document.getElementById('permission-message');
    const errorMessage = document.getElementById('error-message');

    // --- Initialization ---
    function init() {
        populateDropdowns();
        setMode(false); // Default to Text Only
        loadVoices();
        
        window.addEventListener('resize', () => {
            document.body.style.height = window.innerHeight + 'px';
        });
    }

    function populateDropdowns() {
        languages.forEach(lang => {
            const sourceOption = new Option(lang.name, lang.code);
            const targetOption = new Option(lang.name, lang.code);
            sourceSelect.add(sourceOption);
            targetSelect.add(targetOption);
        });

        // Set Defaults: English -> Spanish
        sourceSelect.value = 'en-US';
        targetSelect.value = 'es-ES';
    }

    function setMode(audioEnabled) {
        isAudioMode = audioEnabled;
        if (isAudioMode) {
            modeAudioBtn.classList.add('active');
            modeTextBtn.classList.remove('active');
        } else {
            modeTextBtn.classList.add('active');
            modeAudioBtn.classList.remove('active');
            window.speechSynthesis.cancel();
            hideVoiceToast();
        }
    }

    window.setMode = setMode;

    // --- Speech Synthesis (Voices) ---
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
    }
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function getBestVoice(langCode) {
        // 1. Filter for language match (exact or base)
        let candidates = availableVoices.filter(v => v.lang === langCode);
        
        if (candidates.length === 0) {
            const base = langCode.split('-')[0];
            candidates = availableVoices.filter(v => v.lang.startsWith(base));
        }

        if (candidates.length === 0) return null;

        // 2. Prioritize "Natural" / High Quality voices
        // These keywords usually indicate higher quality browser voices
        const highQuality = ['Google', 'Premium', 'Enhanced', 'Natural', 'Neural', 'Siri', 'Online'];
        
        return candidates.sort((a, b) => {
            const aName = a.name;
            const bName = b.name;
            const aHQ = highQuality.some(w => aName.includes(w));
            const bHQ = highQuality.some(w => bName.includes(w));
            
            if (aHQ && !bHQ) return -1;
            if (!aHQ && bHQ) return 1;
            return 0;
        })[0];
    }

    function speakText(text, langCode) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        const voice = getBestVoice(langCode);
        
        if (voice) {
            utterance.voice = voice;
            utterance.lang = voice.lang;
            // Clean up voice name for display (remove messy IDs)
            let displayName = voice.name.replace(/Microsoft |Google |Apple /g, '').split(' - ')[0];
            voiceNameSpan.textContent = displayName; 
        } else {
            utterance.lang = langCode;
            voiceNameSpan.textContent = "System Voice";
        }
        
        utterance.rate = 1.0; 
        
        utterance.onstart = () => showVoiceToast();
        utterance.onend = () => hideVoiceToast();
        utterance.onerror = () => hideVoiceToast();

        window.speechSynthesis.speak(utterance);
    }

    function showVoiceToast() {
        voiceToast.classList.remove('hidden');
        void voiceToast.offsetWidth;
        voiceToast.classList.remove('translate-y-4', 'opacity-0');
    }

    function hideVoiceToast() {
        voiceToast.classList.add('translate-y-4', 'opacity-0');
        setTimeout(() => voiceToast.classList.add('hidden'), 300);
    }

    // --- Translation Logic ---
    async function translateText(text, targetLangCode) {
        const targetSimple = targetLangCode.split('-')[0];
        const apiUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetSimple}&dt=t&q=${encodeURIComponent(text)}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            return data[0].map(item => item[0]).join('');
        } catch (error) {
            console.warn("Translation failed:", error);
            return text;
        }
    }

    // --- UI Update: Add Bubble ---
    function addCaption(original, translated, isRTL) {
        // Remove placeholder if present
        placeholderText.classList.add('hidden');
        
        // Hide Live Preview
        livePreview.classList.add('hidden');
        livePreviewText.textContent = '';

        const div = document.createElement('div');
        div.className = 'caption-enter mb-6';
        
        const alignClass = isRTL ? 'text-right' : 'text-left';
        const dirAttr = isRTL ? 'dir="rtl"' : '';

        div.innerHTML = `
            <div class="flex flex-col gap-2">
                <!-- Source (Top, Smaller) -->
                <div class="flex items-start gap-3 max-w-[90%] self-start opacity-70">
                    <div class="text-xs font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded">Source</div>
                    <p class="text-slate-300 text-sm leading-relaxed">${original}</p>
                </div>

                <!-- Translation (Bottom, Prominent) -->
                <div class="flex items-start gap-3 max-w-[95%] self-end flex-row-reverse mt-1">
                     <div class="bg-indigo-600 p-4 rounded-2xl rounded-tr-none shadow-lg text-white">
                        <p class="text-lg font-medium leading-relaxed ${alignClass}" ${dirAttr}>${translated}</p>
                     </div>
                </div>
            </div>
        `;

        // Insert before the live preview element to keep live preview at bottom
        captionsContainer.insertBefore(div, livePreview);
        captionsContainer.scrollTo({ top: captionsContainer.scrollHeight, behavior: 'smooth' });

        if (isAudioMode) {
            speakText(translated, targetSelect.value);
        }
    }

    function updateLivePreview(text) {
        if (!text) return;
        placeholderText.classList.add('hidden');
        livePreview.classList.remove('hidden');
        livePreviewText.textContent = text;
        captionsContainer.scrollTo({ top: captionsContainer.scrollHeight, behavior: 'smooth' });
    }

    // --- Speech Recognition ---
    function initializeRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showError("Browser not supported. Please use Google Chrome.");
            return false;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        
        // CRITICAL: Enable interim results for real-time visualization
        recognition.interimResults = true;
        
        recognition.lang = sourceSelect.value; 

        recognition.onstart = () => {
            isListening = true;
            toggleUI(true);
            permissionMessage.classList.add('hidden'); // Hide hint once started
        };

        recognition.onend = () => {
            if (isListening) {
                try { recognition.start(); } catch (e) { toggleUI(false); }
            } else {
                toggleUI(false);
            }
        };

        recognition.onerror = (event) => {
            permissionMessage.classList.add('hidden'); // Hide hint on error
            if (event.error === 'no-speech') return;
            if (event.error === 'not-allowed') {
                showError("Microphone blocked. Check browser permissions.");
                isListening = false;
                toggleUI(false);
            } else {
                console.log("Error:", event.error);
            }
        };

        recognition.onresult = async (event) => {
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            // Show Interim results immediately
            if (interimTranscript) {
                updateLivePreview(interimTranscript);
            }

            // Process Final results
            if (finalTranscript) {
                const targetCode = targetSelect.value;
                const translated = await translateText(finalTranscript, targetCode);
                const isRTL = ['ar', 'he'].includes(targetCode.split('-')[0]);
                addCaption(finalTranscript, translated, isRTL);
            }
        };

        return true;
    }

    // --- Controls ---
    async function startSession() {
        if (!recognition) {
            if (!initializeRecognition()) return;
        } else {
            recognition.lang = sourceSelect.value;
        }

        // Show hint in case the browser prompt is subtle
        permissionMessage.classList.remove('hidden');
        
        try {
            recognition.start();
        } catch (e) {
            // If already started or other error, hide message
            console.log("Recognition start error:", e);
            permissionMessage.classList.add('hidden');
        }
    }

    function stopSession() {
        isListening = false;
        if (recognition) recognition.stop();
        window.speechSynthesis.cancel();
        livePreview.classList.add('hidden'); // Clear preview on stop
    }

    function toggleUI(listening) {
        if (listening) {
            // Active State
            placeholderText.classList.add('hidden'); // Hide placeholder
            headerControls.classList.remove('hidden'); // Show header controls row
            stopBtn.classList.remove('hidden');
            headerStartBtn.classList.add('hidden');
            statusBadge.classList.remove('hidden');
            
            // Disable inputs
            sourceSelect.disabled = true;
            sourceSelect.classList.add('opacity-50');
        } else {
            // Stopped State
            headerControls.classList.remove('hidden'); // Keep header row visible for resume
            stopBtn.classList.add('hidden');
            headerStartBtn.classList.remove('hidden'); // Show resume button
            statusBadge.classList.add('hidden');
            
            // Re-enable inputs
            sourceSelect.disabled = false;
            sourceSelect.classList.remove('opacity-50');
        }
    }

    function showError(msg) {
        const errEl = document.getElementById('error-message');
        document.getElementById('error-text').textContent = msg;
        errEl.classList.remove('hidden');
        setTimeout(() => errEl.classList.add('hidden'), 5000);
    }

    // Event Listeners
    heroStartBtn.addEventListener('click', startSession);
    headerStartBtn.addEventListener('click', startSession);
    stopBtn.addEventListener('click', stopSession);

    // Boot
    init();

  </script>
 </body>
</html>